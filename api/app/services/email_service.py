"""
Email service for sending notifications
Uses SMTP (Microsoft 365 / Outlook)
"""
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from typing import List, Optional
import logging

from app.config import settings

logger = logging.getLogger(__name__)


class EmailService:
    """Email service for sending notifications"""

    def __init__(self):
        self.smtp_host = settings.SMTP_HOST
        self.smtp_port = settings.SMTP_PORT
        self.smtp_user = settings.SMTP_USER
        self.smtp_password = settings.SMTP_PASSWORD
        self.from_email = settings.SMTP_FROM_EMAIL
        self.from_name = settings.SMTP_FROM_NAME

    def send_email(
        self,
        to_email: str,
        subject: str,
        body_html: str,
        body_text: str,
        cc: Optional[List[str]] = None,
        bcc: Optional[List[str]] = None
    ) -> bool:
        """
        Send an email

        Args:
            to_email: Recipient email address
            subject: Email subject
            body_html: HTML body content
            body_text: Plain text body content
            cc: CC recipients (optional)
            bcc: BCC recipients (optional)

        Returns:
            True if email sent successfully, False otherwise
        """
        try:
            # Create message
            msg = MIMEMultipart('alternative')
            msg['Subject'] = subject
            msg['From'] = f"{self.from_name} <{self.from_email}>"
            msg['To'] = to_email

            if cc:
                msg['Cc'] = ', '.join(cc)
            if bcc:
                msg['Bcc'] = ', '.join(bcc)

            # Attach both plain text and HTML versions
            part_text = MIMEText(body_text, 'plain', 'utf-8')
            part_html = MIMEText(body_html, 'html', 'utf-8')

            msg.attach(part_text)
            msg.attach(part_html)

            # Send email
            with smtplib.SMTP(self.smtp_host, self.smtp_port) as server:
                server.starttls()
                if self.smtp_password:
                    server.login(self.smtp_user, self.smtp_password)

                recipients = [to_email]
                if cc:
                    recipients.extend(cc)
                if bcc:
                    recipients.extend(bcc)

                server.send_message(msg)

            logger.info(f"Email sent successfully to {to_email}")
            return True

        except Exception as e:
            logger.error(f"Failed to send email to {to_email}: {e}")
            return False

    def send_welcome_email(
        self,
        user_email: str,
        user_name_ar: str,
        temp_password: str,
        login_url: str = "http://localhost:8080"
    ) -> bool:
        """
        Send welcome email to new user with temporary credentials

        Args:
            user_email: User's email address
            user_name_ar: User's Arabic name
            temp_password: Temporary password
            login_url: URL to login page

        Returns:
            True if email sent successfully
        """
        subject = "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ù†ØµØ© Ø±Ø§Ù‚Ø¨ - Welcome to Raqib Platform"

        # HTML body
        body_html = f"""
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <style>
        body {{ font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction: rtl; }}
        .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}
        .header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }}
        .content {{ background: #f8f9fa; padding: 30px; border-radius: 0 0 10px 10px; }}
        .credentials {{ background: white; padding: 20px; border-radius: 5px; border-left: 4px solid #667eea; margin: 20px 0; }}
        .credential-item {{ margin: 10px 0; font-size: 16px; }}
        .credential-label {{ font-weight: bold; color: #495057; }}
        .credential-value {{ color: #212529; background: #e9ecef; padding: 8px 12px; border-radius: 4px; display: inline-block; font-family: monospace; }}
        .button {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 20px 0; font-weight: bold; }}
        .footer {{ text-align: center; margin-top: 30px; color: #6c757d; font-size: 14px; }}
        .warning {{ background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 15px; border-radius: 5px; margin: 20px 0; }}
        .steps {{ background: white; padding: 20px; border-radius: 5px; margin: 20px 0; }}
        .step {{ margin: 15px 0; padding-right: 30px; position: relative; }}
        .step-number {{ position: absolute; right: 0; background: #667eea; color: white; width: 24px; height: 24px; border-radius: 50%; text-align: center; line-height: 24px; font-size: 14px; }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‰ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ù†ØµØ© Ø±Ø§Ù‚Ø¨</h1>
            <p>Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª</p>
        </div>
        <div class="content">
            <h2>Ø¹Ø²ÙŠØ²ÙŠ/Ø¹Ø²ÙŠØ²ØªÙŠ {user_name_ar}ØŒ</h2>

            <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ù„Ùƒ ÙÙŠ Ù…Ù†ØµØ© Ø±Ø§Ù‚Ø¨. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†ØµØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>

            <div class="credentials">
                <div class="credential-item">
                    <span class="credential-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</span><br>
                    <span class="credential-value">{user_email}</span>
                </div>
                <div class="credential-item">
                    <span class="credential-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ©:</span><br>
                    <span class="credential-value">{temp_password}</span>
                </div>
            </div>

            <div class="warning">
                <strong>âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ:</strong><br>
                ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‡Ø°Ù‡ Ù…Ø¤Ù‚ØªØ©. Ø³ÙŠÙØ·Ù„Ø¨ Ù…Ù†Ùƒ ØªØºÙŠÙŠØ±Ù‡Ø§ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©.
            </div>

            <div class="steps">
                <h3>Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¨Ø¯Ø¡:</h3>
                <div class="step">
                    <span class="step-number">1</span>
                    Ù‚Ù… Ø¨Ø²ÙŠØ§Ø±Ø© Ù…Ù†ØµØ© Ø±Ø§Ù‚Ø¨
                </div>
                <div class="step">
                    <span class="step-number">2</span>
                    Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ©
                </div>
                <div class="step">
                    <span class="step-number">3</span>
                    Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆØ§Ù„ÙˆØ¸ÙŠÙÙŠØ©
                </div>
                <div class="step">
                    <span class="step-number">4</span>
                    Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ¢Ù…Ù†Ø©
                </div>
                <div class="step">
                    <span class="step-number">5</span>
                    Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù†ØµØ©!
                </div>
            </div>

            <center>
                <a href="{login_url}" class="button">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†
                </a>
            </center>

            <div class="footer">
                <p>Ø¥Ø°Ø§ Ù„Ù… ØªØ·Ù„Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù….</p>
                <p>Â© 2025 ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ¦Ø© ÙˆØ§Ù„Ù…ÙŠØ§Ù‡ ÙˆØ§Ù„Ø²Ø±Ø§Ø¹Ø© - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
                <p style="font-size: 12px; color: #adb5bd;">
                    Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©ØŒ ÙŠØ±Ø¬Ù‰ Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§.
                </p>
            </div>
        </div>
    </div>
</body>
</html>
        """

        # Plain text body
        body_text = f"""
Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ù†ØµØ© Ø±Ø§Ù‚Ø¨
Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª

Ø¹Ø²ÙŠØ²ÙŠ/Ø¹Ø²ÙŠØ²ØªÙŠ {user_name_ar}ØŒ

ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ù„Ùƒ ÙÙŠ Ù…Ù†ØµØ© Ø±Ø§Ù‚Ø¨.

Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„:
--------------
Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: {user_email}
ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ©: {temp_password}

ØªÙ†Ø¨ÙŠÙ‡: Ù‡Ø°Ù‡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ©. Ø³ÙŠÙØ·Ù„Ø¨ Ù…Ù†Ùƒ ØªØºÙŠÙŠØ±Ù‡Ø§ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©.

Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù†ØµØ©:
{login_url}

Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¨Ø¯Ø¡:
1. Ù‚Ù… Ø¨Ø²ÙŠØ§Ø±Ø© Ù…Ù†ØµØ© Ø±Ø§Ù‚Ø¨
2. Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ©
3. Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆØ§Ù„ÙˆØ¸ÙŠÙÙŠØ©
4. Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ¢Ù…Ù†Ø©
5. Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù†ØµØ©!

Â© 2025 ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ¦Ø© ÙˆØ§Ù„Ù…ÙŠØ§Ù‡ ÙˆØ§Ù„Ø²Ø±Ø§Ø¹Ø©
        """

        return self.send_email(
            to_email=user_email,
            subject=subject,
            body_html=body_html,
            body_text=body_text
        )


# Singleton instance
email_service = EmailService()
